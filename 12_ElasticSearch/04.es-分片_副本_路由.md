# es-分片/副本/路由

## 一.分片的作用

- 为了实现`“集群总数据量 超过 单机容量”`，但又想明面上保持一整个索引，所以数据需要被分片（系统自动完成，屏蔽了细节）

- 写入数据时，分配到多个分片上，通过如下算法计算
    ```js
    要写入的分片编号 = 哈希(_routing) % 主分片总数

    _routing一般取id或者parent字段，这样好处是保证各分片数据量均匀，也可以自己指定从而从特定分片存取
    ```

- 读取数据时，查询所有分片并汇总结果

## 二.副本的作用 

- 为了实现`“高可用和数据安全”`，数据中的每个分片都要创建一模一样的冗余副本


- 如下设置主分片数量和副本数量

    - 旧版本：yml文件全局设置
       
       ```js
        index.number_of_shards: 5
        index.number_of_replicas: 1
        （分别为1和0则表示禁用）
        ```
    
    - 新版本：不再需要全局设置分片数（全局现在直接默认1个），而是在创建索引时自己在`settings`属性中指定
    
        ```js
        "settings":{
            "number_of_shards": 3,
            "number_of_replicas": 1
        }
        ```

## 三.路由的作用

- 为了实现`“直接从某个分片存取数据”`，避免要查询所有分片后再汇总造成性能损耗，所以数据可以指定“路由键”来选择分片写入，查询取出时可以在？后面加上`routing=路由键`

- “路由键”可以是任意字符串，会被哈希后除以总分片数，同时记录在结果的`“_routing"`字段，只要存储时这个字符串固定，数据就会进入到同一个分片，查询时也会显示`“_shared"`中的`“total”`为1

